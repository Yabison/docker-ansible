name: Publish Docker image

on:
  release:
    types: [published]

# ✅ PRINCIPE DU MOINDRE PRIVILÈGE
# Tout est read-only par défaut, on surcharge au niveau du job
permissions:
  contents: read

jobs:
  push_to_registry:
    runs-on: ubuntu-latest

    # ✅ Permissions minimales et explicites au niveau du job
    permissions:
      contents: read
      packages: write
      security-events: write  # Requis pour upload-sarif → GitHub Code Scanning
      id-token: write         # Requis pour cosign (signature d'image)

    # ✅ Empêche les injections de commandes via les variables d'environnement
    env:
      IMAGE_NAME: yabison/docker-ansible
      # Référence de l'image sans interpolation directe dans les run steps
      IMAGE_REF: yabison/docker-ansible:${{ github.ref_name }}

    steps:
      # ✅ Pin SHA exact (pas @v4 qui peut changer) pour éviter supply chain attacks
      - name: Check out the repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      # ✅ Vérification de l'intégrité du Dockerfile et du contexte
      - name: Lint Dockerfile (Hadolint)
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf  # v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

      - name: Log in to Docker Hub
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567  # v3.3.0
        with:
          username: ${{ vars.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ✅ Installer cosign pour la signature d'image (supply chain security)
      - name: Install cosign
        uses: sigstore/cosign-installer@dc72c7d5c4d10cd6bcb8cf6e3fd625a9e5e537da  # v3.7.0

      # ✅ Setup Docker Buildx avec provenance et SBOM natifs
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5  # v3.8.0

      # ✅ Extraction de version sécurisée — pas d'interpolation directe dans shell
      - name: Extract version from tag
        id: get_version
        run: |
          # Validation stricte du format de tag (ex: v1.2.3)
          if [[ ! "${GITHUB_REF}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag format invalide. Format attendu: vX.Y.Z"
            exit 1
          fi
          VERSION=$(echo "${GITHUB_REF}" | sed 's|refs/tags/||' | sed 's/^v//')
          echo "VERSION=${VERSION}" >> "${GITHUB_OUTPUT}"
        shell: bash

      # ✅ Build avec provenance SLSA level 3 et SBOM intégré
      - name: Build image
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355  # v6.10.0
        id: build
        with:
          context: .
          push: false   # On ne pousse pas encore — scan d'abord
          load: true    # Charge l'image localement pour le scan
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.IMAGE_NAME }}:latest
          # ✅ SLSA provenance pour la supply chain
          provenance: true
          sbom: true
          # ✅ Cache pour accélérer sans compromettre la sécurité
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # =============================================
      # BLOC SÉCURITÉ — TOUT AVANT LE PUSH
      # =============================================

      # ✅ Scan de vulnérabilités — résultats en JSON pour artefact
      - name: Scan vulnérabilités (JSON)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: json
          output: trivy-report.json
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig  # ✅ Scan aussi les secrets et misconfigs
          ignore-unfixed: true
          exit-code: 0

      # ✅ Scan SARIF → envoyé à GitHub Security (Code Scanning)
      - name: Scan SARIF pour GitHub Security
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig
          ignore-unfixed: true
          exit-code: 0  # Changer à 1 pour bloquer le push si vuln détectée
          skip-setup-trivy: true  # ✅ Trivy déjà installé par le step précédent

      # ✅ CE STEP ÉTAIT MANQUANT — alimente l'onglet Security → Code Scanning
      - name: Upload SARIF vers GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@dd746615b3b9d728a6a37ca2045b68ca76d4841a  # v3.28.0
        if: always()
        with:
          sarif_file: trivy-results.sarif

      # ✅ SBOM au format CycloneDX
      - name: Générer SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: cyclonedx
          output: sbom.cyclonedx.json
          exit-code: 0
          skip-setup-trivy: true  # ✅ Trivy déjà installé

      # ✅ Archivage de tous les rapports de sécurité
      - name: Upload artefacts sécurité
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: security-reports-${{ github.ref_name }}
          path: |
            trivy-report.json
            trivy-results.sarif
            sbom.cyclonedx.json
          retention-days: 90

      # =============================================
      # PUSH — seulement après validation sécurité
      # =============================================

      - name: Push images
        run: |
          docker push "${{ env.IMAGE_NAME }}:${{ github.ref_name }}"
          docker push "${{ env.IMAGE_NAME }}:latest"

      # ✅ Signature de l'image avec Sigstore/cosign (keyless via OIDC)
      # Permet aux utilisateurs de vérifier l'authenticité de l'image
      - name: Signer l'image avec cosign (keyless)
        run: |
          cosign sign --yes \
            "${{ env.IMAGE_NAME }}:${{ github.ref_name }}@${{ steps.build.outputs.digest }}"
          cosign sign --yes \
            "${{ env.IMAGE_NAME }}:latest@${{ steps.build.outputs.digest }}"

      # ✅ Attacher le SBOM à l'image dans le registry
      - name: Attacher SBOM à l'image
        run: |
          cosign attach sbom \
            --sbom sbom.cyclonedx.json \
            --type cyclonedx \
            "${{ env.IMAGE_NAME }}:${{ github.ref_name }}@${{ steps.build.outputs.digest }}"
