name: Publish Docker image

on:
  release:
    types: [published]

# ✅ Moindre privilège — read-only global, surcharge au niveau job
permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      security-events: write  # upload-sarif → GitHub Code Scanning
      id-token: write         # cosign keyless OIDC

    env:
      IMAGE_NAME: yabison/docker-ansible
      DOCKERFILE: docker/Dockerfile

    steps:
      # ─────────────────────────────────────────────
      # SETUP
      # ─────────────────────────────────────────────

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      # Validation stricte du tag : vX.Y.Z obligatoire
      - name: Valider et extraire la version
        id: version
        run: |
          if [[ ! "${GITHUB_REF}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag invalide. Format attendu : vX.Y.Z (ex: v2.1.0)"
            exit 1
          fi
          # "v2.1.0" → "2.1.0"
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
        shell: bash

      # ✅ Lit le .env du repo et expose chaque variable en output
      # C'est la même source que le Makefile et docker-compose → zéro duplication
      - name: Charger les variables depuis .env
        id: dotenv
        run: |
          if [ ! -f ".env" ]; then
            echo "::error::.env introuvable à la racine du repo"
            exit 1
          fi
          # Parse le .env : ignore les commentaires et les lignes vides
          while IFS= read -r line; do
            # Ignorer commentaires et lignes vides
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            [[ -z "${line// }" ]] && continue
            # Extraire KEY=VALUE (supporte les valeurs avec espaces si entre guillemets)
            if [[ "$line" =~ ^([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
              key="${BASH_REMATCH[1]}"
              val="${BASH_REMATCH[2]}"
              # Supprimer les guillemets optionnels autour de la valeur
              val="${val%\"}"
              val="${val#\"}"
              val="${val%\'}"
              val="${val#\'}"
              echo "${key}=${val}" >> "${GITHUB_OUTPUT}"
              echo "  → ${key}=${val}"
            fi
          done < .env
        shell: bash

      - name: Lint Dockerfile (Hadolint)
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf  # v3.1.0
        with:
          dockerfile: ${{ env.DOCKERFILE }}
          failure-threshold: warning

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5  # v3.8.0

      - name: Log in to Docker Hub
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567  # v3.3.0
        with:
          username: ${{ vars.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install cosign
        uses: sigstore/cosign-installer@dc72c7d5c4d10cd6bcb8cf6e3fd625a9e5e537da  # v3.7.0

      # ─────────────────────────────────────────────
      # BUILD — build-push-action avec tous les ARGs
      # ✅ Même variables que Makefile + docker-compose
      # ✅ Cache GHA + provenance SLSA L3 + SBOM natifs
      # ✅ push:false → scan Trivy avant tout push
      # ─────────────────────────────────────────────

      - name: Build image
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355  # v6.10.0
        id: build
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          push: false   # Scan d'abord, push ensuite
          load: true    # Charge localement pour Trivy
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.IMAGE_NAME }}:latest
          # ✅ Tous les ARGs du Dockerfile — source : .env + contexte GitHub
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.release.created_at }}
            VCS_REF=${{ github.sha }}
            VCS_URL=https://github.com/${{ github.repository }}
            ALPINE_VERSION=${{ steps.dotenv.outputs.ALPINE_VERSION }}
            PYTHON_VERSION=${{ steps.dotenv.outputs.PYTHON_VERSION }}
            PASSBOLT_CLI_VERSION=${{ steps.dotenv.outputs.PASSBOLT_CLI_VERSION }}
            SUPERCRONIC_VERSION=${{ steps.dotenv.outputs.SUPERCRONIC_VERSION }}
            DEVOPS_USER=${{ steps.dotenv.outputs.DEVOPS_USER }}
            DEVOPS_GROUP=${{ steps.dotenv.outputs.DEVOPS_GROUP }}
            DEVOPS_UID=1000
            DEVOPS_GID=1000
          provenance: true
          sbom: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ─────────────────────────────────────────────
      # SÉCURITÉ — tout avant le push
      # ─────────────────────────────────────────────

      - name: Scan vulnérabilités → JSON (artefact)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          format: json
          output: trivy-report.json
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig
          ignore-unfixed: true
          exit-code: 0   # Passer à 1 pour bloquer si CRITICAL détectée

      - name: Scan vulnérabilités → SARIF (GitHub Security)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig
          ignore-unfixed: true
          exit-code: 0
          skip-setup-trivy: true

      - name: Upload SARIF → GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@dd746615b3b9d728a6a37ca2045b68ca76d4841a  # v3.28.0
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Générer SBOM CycloneDX
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          format: cyclonedx
          output: sbom.cyclonedx.json
          exit-code: 0
          skip-setup-trivy: true

      - name: Upload artefacts sécurité
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: security-reports-${{ github.ref_name }}
          path: |
            trivy-report.json
            trivy-results.sarif
            sbom.cyclonedx.json
          retention-days: 90

      # ─────────────────────────────────────────────
      # PUSH — seulement après validation sécurité
      # ✅ Cache GHA chaud → rebuild quasi instantané
      # ─────────────────────────────────────────────

      - name: Push images
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355  # v6.10.0
        id: push
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.IMAGE_NAME }}:latest
          # ✅ Mêmes build-args que le step Build — cohérence garantie
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.release.created_at }}
            VCS_REF=${{ github.sha }}
            VCS_URL=https://github.com/${{ github.repository }}
            ALPINE_VERSION=${{ steps.dotenv.outputs.ALPINE_VERSION }}
            PYTHON_VERSION=${{ steps.dotenv.outputs.PYTHON_VERSION }}
            PASSBOLT_CLI_VERSION=${{ steps.dotenv.outputs.PASSBOLT_CLI_VERSION }}
            SUPERCRONIC_VERSION=${{ steps.dotenv.outputs.SUPERCRONIC_VERSION }}
            DEVOPS_USER=${{ steps.dotenv.outputs.DEVOPS_USER }}
            DEVOPS_GROUP=${{ steps.dotenv.outputs.DEVOPS_GROUP }}
            DEVOPS_UID=1000
            DEVOPS_GID=1000
          provenance: true
          sbom: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ─────────────────────────────────────────────
      # SIGNATURE — cosign keyless via OIDC Sigstore
      # Signe par digest (immuable), pas par tag (mutable)
      # ─────────────────────────────────────────────

      - name: Signer l'image avec cosign (keyless)
        run: |
          cosign sign --yes \
            "${{ env.IMAGE_NAME }}@${{ steps.push.outputs.digest }}"
        env:
          COSIGN_EXPERIMENTAL: "1"

      - name: Attacher le SBOM à l'image
        run: |
          cosign attach sbom \
            --sbom sbom.cyclonedx.json \
            --type cyclonedx \
            "${{ env.IMAGE_NAME }}@${{ steps.push.outputs.digest }}"
