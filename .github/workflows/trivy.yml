name: Trivy Security Scan

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "docker/Dockerfile"
      - "docker/**"
      - ".env"
  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "docker/Dockerfile"
      - "docker/**"
      - ".env"
  schedule:
    # Scan hebdomadaire tous les mercredis à 11h17 UTC
    # Détecte les nouvelles CVEs même sans commit
    - cron: '17 11 * * 3'

# ✅ Moindre privilège — read-only global, surcharge au niveau job
permissions:
  contents: read

jobs:
  trivy-scan:
    name: Build + Trivy scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write  # upload-sarif → GitHub Code Scanning tab
      actions: read           # requis pour upload-sarif sur repo privé

    env:
      IMAGE_NAME: yabison/docker-ansible
      DOCKERFILE: docker/Dockerfile

    steps:
      # ─────────────────────────────────────────────
      # SETUP
      # ─────────────────────────────────────────────

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      # ✅ Lit le .env du repo — même source que Makefile et CI publish
      - name: Charger les variables depuis .env
        id: dotenv
        run: |
          if [ ! -f ".env" ]; then
            echo "::warning::.env introuvable — ARGs Dockerfile utiliseront leurs valeurs par défaut"
            exit 0
          fi
          while IFS= read -r line; do
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            [[ -z "${line// }"            ]] && continue
            if [[ "$line" =~ ^([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
              key="${BASH_REMATCH[1]}"
              val="${BASH_REMATCH[2]%\"}"; val="${val#\"}"; val="${val%\'}"; val="${val#\'}"
              echo "${key}=${val}" >> "${GITHUB_OUTPUT}"
            fi
          done < .env
        shell: bash

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5  # v3.8.0

      # ─────────────────────────────────────────────
      # BUILD — mêmes ARGs que le CI publish
      # amd64 uniquement + load:true → Trivy peut scanner localement
      # ─────────────────────────────────────────────

      - name: Build image (amd64 — pour scan Trivy)
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355  # v6.10.0
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: linux/amd64   # amd64 seulement — load:true incompatible multi-arch
          push: false
          load: true               # requis pour que Trivy accède à l'image locale
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          build-args: |
            VERSION=dev-${{ github.sha }}
            BUILD_DATE=${{ github.run_started_at }}
            VCS_REF=${{ github.sha }}
            VCS_URL=https://github.com/${{ github.repository }}
            ALPINE_VERSION=${{ steps.dotenv.outputs.ALPINE_VERSION }}
            PYTHON_VERSION=${{ steps.dotenv.outputs.PYTHON_VERSION }}
            PASSBOLT_CLI_VERSION=${{ steps.dotenv.outputs.PASSBOLT_CLI_VERSION }}
            SUPERCRONIC_VERSION=${{ steps.dotenv.outputs.SUPERCRONIC_VERSION }}
            DEVOPS_USER=${{ steps.dotenv.outputs.DEVOPS_USER }}
            DEVOPS_GROUP=${{ steps.dotenv.outputs.DEVOPS_GROUP }}
            DEVOPS_UID=1000
            DEVOPS_GID=1000
          # ✅ Cache GHA — layers partagés avec le CI publish
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ─────────────────────────────────────────────
      # SCAN TRIVY — 3 formats complémentaires
      # ─────────────────────────────────────────────

      # Format SARIF → onglet Security > Code Scanning de GitHub
      - name: Scan → SARIF (GitHub Security tab)
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284  # v0.34.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig
          ignore-unfixed: true
          exit-code: 0   # ← Passer à 1 pour bloquer la PR si CRITICAL détectée

      # Format JSON → artefact téléchargeable pour audit/intégration
      - name: Scan → JSON (artefact)
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284  # v0.34.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: json
          output: trivy-report.json
          severity: CRITICAL,HIGH
          scanners: vuln,secret,misconfig
          ignore-unfixed: true
          exit-code: 0
          skip-setup-trivy: true   # Trivy déjà installé par le step précédent

      # Format CycloneDX → SBOM des dépendances de l'image
      - name: Scan → SBOM CycloneDX
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284  # v0.34.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: cyclonedx
          output: sbom.cyclonedx.json
          exit-code: 0
          skip-setup-trivy: true

      # ─────────────────────────────────────────────
      # PUBLICATION DES RÉSULTATS
      # ─────────────────────────────────────────────

      - name: Upload SARIF → GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@dd746615b3b9d728a6a37ca2045b68ca76d4841a  # v3.28.0
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Upload artefacts sécurité
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: trivy-reports-${{ github.sha }}
          path: |
            trivy-report.json
            trivy-results.sarif
            sbom.cyclonedx.json
          retention-days: 30
